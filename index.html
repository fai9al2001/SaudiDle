<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SaudiDle v7</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; background: #111; margin:0; direction: rtl; color: #D9D9D9;}
        #top-bar {
            width: 100%;
            background: #232323;
            color: #D9D9D9;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0;
            height: 56px;
            box-sizing: border-box;
            position: sticky;
            top: 0;
            z-index: 1001;
            border-bottom: 2px solid #444;
        }
        #site-title {
            flex: 1;
            text-align: center;
            font-size: 2em;
            font-weight: bold;
            color: #1B9E49;
            letter-spacing: 2px;
        }
        #top-buttons {
            display: flex;
            align-items: center;
            gap: 8px;
            height: 100%;
            margin-right: 0;
        }
        #top-buttons button,
button {
    background: #1B9E49;
    color: #fff;
    border: none;
    padding: 8px 16px;
    font-size: 1.1em;
    border-radius: 24px;
    cursor: pointer;
    margin: 0 4px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    transition: background 0.2s, color 0.2s, transform 0.2s;
    outline: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}
#top-buttons button:active,
#top-buttons button:focus,
#top-buttons button:hover,
button:active,
button:focus,
button:hover {
    background: #157a36;
    color: #fff;
    transform: scale(1.05);
}
        #city-nav-bar {
            margin: 24px auto 0 auto; max-width: 880px; display: flex; align-items: center; justify-content: space-between;
        }
        #prev-city-btn {
            font-size:1.1em; padding:8px 18px; border-radius:18px; background:#1B9E49; color:#fff; border:none; cursor:pointer;
        }
        #city-number {
            font-size:1.2em; color:#1B9E49; font-weight:bold;
        }
        #image-container { position: relative; display: inline-block; margin-top: 20px; }
        #main-image {
            width: 100vw;
            max-width: 880px;
            height: 457px;
            object-fit: cover;
            border-radius: 8px;
            margin-top: 20px;
            display: block;
            margin-left: auto;
            margin-right: auto;
            box-shadow: 0 0 10px #90caf9;
            transition: box-shadow 0.5s, transform 0.5s;
        }
        #map-thumb { position: absolute; bottom: 10px; right: 10px; width: 166px; height: 100px;
            border: 2px solid #ccc; border-radius: 8px; overflow: hidden; cursor: pointer; z-index: 10; transition: transform 0.3s ease; }
  #map-thumb.expanded {
    position: absolute;
    bottom: 10px;
    right: 10px;
    width: 350px;
    height: 220px;
    max-width: 98vw;
    border-radius: 18px;
    z-index: 1002;
    box-shadow: 0 0 30px #222;
    transition: width 0.3s, height 0.3s;
}
        #close-map-btn {
            font-size: 1.3em;
            background: #222;
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 38px;
            height: 38px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.18);
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1003;
        }
        #popup, #win-popup, #settings-popup, #city-list-popup {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: #1F2023; color: #D9D9D9; border-radius: 32px; box-shadow: 0 0 20px rgba(0,0,0,0.3);
            z-index: 9999; max-width: 400px; width: 90%; text-align: center; padding: 24px; display: none;
        }
        .result-card, .quiz {
            background: #1F2023; color: #D9D9D9; border-radius: 32px; border: none;
            box-shadow: 0 0 10px rgba(0,0,0,0.2); display: inline-block; text-align: center; padding: 15px; margin-top: 20px;
        }
        .quiz h3 { margin-top: 0; }
        .quiz button { margin: 5px; padding: 8px 12px; border-radius: 32px; }
        #loading-bar-container { width:70%;max-width:700px;margin:20px auto 0 auto;display:none; }
        #loading-bar { height:18px;background:linear-gradient(90deg,#1B9E49,#222);border-radius:8px;width:0%;transition:width 1s;}
        #gallery { display:none; margin: 30px auto; max-width: 900px;}
        @media (max-width: 600px) {
            #main-image  { width: 85vw; max-width: 420px; height: 210px; }
            #map-thumb { width: 130px; height: 90px; border-radius: 8px; bottom: 12px; right: 12px;}
            #map-thumb.expanded { width: 70vw; height: 180px; }
            #popup, #win-popup, #settings-popup, #city-list-popup { max-width: 98vw; min-width: 320px; width: 90vw; padding: 16px;}
        }
        @media (max-width: 600px) {
    #map-thumb:hover {
        /* Don't expand on hover for mobile */
    }
}
    </style>
</head>
<body>
    <div id="top-bar">
        <div style="width:132px;"></div>
        <div id="site-title">SaudiDle</div>
        <div id="top-buttons">
            <button id="stats-top-btn" title="إحصائيات">📊</button>
            <button id="help-top-btn" title="تعليمات اللعب">❓</button>
            <button id="settings-top-btn" title="إعدادات">⚙️</button>
        </div>
    </div>
    <div id="city-nav-bar">
        <button id="prev-city-btn">حاول تخمن المدن السابقة!</button>
        <span id="city-number">المدينة رقم <span id="city-num-value">1</span></span>
    </div>
    <div id="image-container">
        <img id="main-image" src="" alt="city image">
        <div id="map-thumb">
    <button id="close-map-btn" style="display:none;">✖</button>
    <button id="confirm-map-btn" style="display:none;position:absolute;bottom:10px;left:10px;z-index:1004;">تأكيد</button>
</div>
    </div>
    <div id="popup">
        <h2>مرحبًا بك في SaudiDle</h2>
        <p>حاول تخمن المدينة السعودية من خلال الصور وحدد موقعها عن طريق الخريطة . لديك 5 محاولات ومع كل محاولة هناك صورة جديدة بتوضح لك اكثر.</p>
        <h3>معاني الإيموجي:</h3>
        <ul>
            <li>🟨 قريب جدًا (اقل من 100 كم)</li>
            <li>🟧 قريب نسبيًا (بين 101 و 199 كم)</li>
            <li>🟥 بعيد (+200 كم)</li>
        </ul>
        <button onclick="closePopup()">ابدأ</button>
    </div>
    <div id="confirm-message" style="margin-top:10px;"></div>
    <div id="settings-popup">
        <h2>الإعدادات</h2>
        <label style="font-size:1.2em;">
            <input type="checkbox" id="dark-mode-toggle" checked style="transform:scale(1.3);margin-left:8px;">
            تفعيل الوضع الليلي (Dark Mode)
        </label>
        <br>
        <button onclick="closeSettingsPopup()" style="margin-top:15px;">إغلاق</button>
    </div>
    <div id="result"></div>
    <div id="quiz"></div>
    <button id="hint-btn" style="margin-top:25px;">تلميح</button>
    <div id="hint-message" style="margin-top:15px;"></div>
    <div id="win-popup">
        <div id="win-tabs">
            <button id="tab-default" style="font-weight:bold;">نتيجتك</button>
            <button id="tab-stats">إحصائيات</button>
        </div>
        <div id="win-content-default">
            <h2>أحسنت!</h2>
            <p>سلسلتك الحالية: <span id="current-streak">0</span></p>
            <p>أعلى سلسلة سابقة: <span id="max-streak">0</span></p>
            <button id="share-btn">مشاركة النتيجة</button>
        </div>
        <div id="win-content-stats" style="display:none;">
            <h3>إحصائيات المحاولات</h3>
            <div id="horizontal-bar" style="margin:10px 0;"></div>
            <h3>نسبة النجاح اليوم</h3>
            <div id="vertical-bar" style="height:120px; display:flex; align-items:flex-end; justify-content:center;"></div>
        </div>
        <button onclick="closeWinPopup()" style="margin-top:15px;">إغلاق</button>
    </div>
    <div id="loading-bar-container">
        <div id="loading-bar"></div>
    </div>
    <div id="gallery"></div>
    <div id="city-list-popup">
        <h2 style="color:#1B9E49;">اختر مدينة للعب</h2>
        <div id="city-list-grid" style="display:flex;flex-wrap:wrap;justify-content:center;gap:16px;margin-top:18px;"></div>
        <button onclick="closeCityListPopup()" style="margin-top:18px;">إغلاق</button>
    </div>
    <script>
    // --- Data ---
    const cityData = [
        {
            name: "أبها",
            coords: [18.21639, 42.50528],
            province: "عسير",
            radius: 12,
            images: [
                "assets/abha_1.webp",
                "assets/abha_2.webp",
                "assets/abha_3.webp",
                "assets/abha_4.webp",
                "assets/abha_5.webp"
            ],
            imageDescriptions: [
                "سد أبها يقع في الطرف الغربي لمدينة أبها في جنوب المملكة العربية السعودية، وتم إنشاؤه في عام 1974",
                "القرية المعلقة في أبها: تقع القرية المعلقة في أبها على حافة منحدرات جبل السروات الشاهقة، وتتميز بإطلالات مذهلة على الطبيعة الجبلية الخلابة",
                "منتزه عسير الوطني في أبها",
                "أشجار الجاكرندا في شوارع ومنتزهات مدينة أبها ، التي تتميز عن باقي الأشجار بلونها البنفسجي الجذاب",
                "ممشى الضباب"
            ],
            quiz: [
                {
                    question: "كم يبلغ عدد سكان مدينة أبها؟",
                    options: ["اقل من 400 الف نسمة", "اكثر من 500 الف نسمة", "400 الف - 500 الف"],
                    correct: "400 الف - 500 الف"
                }
            ]
        },
        {
            name: "الرياض",
            coords: [24.7136, 46.6753],
            province: "الرياض",
            radius: 35,
            images: [
                "assets/riyadh_1.webp",
                "assets/riyadh_2.webp",
                "assets/riyadh_3.webp",
                "assets/riyadh_4.webp",
                "assets/riyadh_5.webp"
            ],
            imageDescriptions: [
                "الرياض في الليل",
                "برج المملكة",
                "الحدائق في الرياض",
                "شوارع الرياض",
                "غروب الشمس في الرياض"
            ],
            quiz: [
                {
                    question: "كم عدد سكان الرياض؟",
                    options: ["٥-٦ مليون", "٤-٥ مليون", "٣-٤ مليون"],
                    correct: "٥-٦ مليون"
                },
                {
                    question: "ما اسم أطول برج في الرياض؟",
                    options: ["برج المملكة", "برج الفيصلية", "برج رافال"],
                    correct: "برج المملكة"
                },
                {
                    question: "ما هو رمز مدينة الرياض؟",
                    options: ["النخلة", "البرج", "الجمل"],
                    correct: "النخلة"
                }
            ]
        }
    ];
    const dateCityMap = {
        "2025-08-14": 0,
        "2025-08-15": 1
    };
    const todayStr = new Date().toISOString().slice(0, 10);
    let cityIndex = dateCityMap[todayStr] !== undefined ? dateCityMap[todayStr] : 0;
    let selectedCity = cityData[cityIndex];
    let images = selectedCity.images;
    let currentImage = 0;
    let correctCity = selectedCity.name;
    let correctCoords = selectedCity.coords;
    let attempts = 0;

    // --- UI Setup ---
    window.onload = function() {
        document.getElementById("main-image").src = images[0];
        updateCityNumber();
        showPopup();
    };

    function updateCityNumber() {
        document.getElementById("city-num-value").textContent = cityIndex + 1;
    }

    // --- Map ---
   
    // --- Popup Logic ---
    function showPopup() {
        const popup = document.getElementById("popup");
        popup.style.display = "block";
        popup.classList.add("fade-in");
    }
    function closePopup() {
        const popup = document.getElementById("popup");
        popup.classList.remove("fade-in");
        popup.classList.add("fade-out");
        setTimeout(() => { popup.style.display = "none"; popup.classList.remove("fade-out"); }, 300);
    }

    // --- Settings ---
    document.getElementById("settings-top-btn").onclick = showSettingsPopup;
    function showSettingsPopup() {
        document.getElementById("settings-popup").style.display = "block";
    }
    function closeSettingsPopup() {
        document.getElementById("settings-popup").style.display = "none";
    }
    document.getElementById("dark-mode-toggle").onchange = function() {
        if(this.checked) document.body.classList.add("dark-mode");
        else document.body.classList.remove("dark-mode");
    };
    document.body.classList.add("dark-mode");
    document.getElementById("dark-mode-toggle").checked = true;

    // --- Hint ---
    document.getElementById("hint-btn").onclick = function() {
        document.getElementById("hint-message").innerHTML =
            `<div class="result-card fade-in" style="margin-top:10px;">
                التلميح: المدينة تقع في منطقة <b>${selectedCity.province}</b>
            </div>`;
    };

    // --- City List Popup ---
    document.getElementById("prev-city-btn").onclick = function() {
        showCityListPopup();
    };
    function getSolvedCities() {
        return JSON.parse(localStorage.getItem("solvedCities") || "[]");
    }
    function markCitySolved(idx) {
        let solved = getSolvedCities();
        if (!solved.includes(idx)) {
            solved.push(idx);
            localStorage.setItem("solvedCities", JSON.stringify(solved));
        }
    }
    function showCityListPopup() {
        const solved = getSolvedCities();
        const grid = document.getElementById("city-list-grid");
        grid.innerHTML = "";
        cityData.forEach((city, idx) => {
            const isSolved = solved.includes(idx);
            grid.innerHTML += `
            <button onclick="selectCity(${idx})"
                style="
                    width:70px;height:70px;
                    margin:4px;
                    font-size:1.2em;
                    border-radius:18px;
                    background:${isSolved ? '#888' : '#1B9E49'};
                    color:#fff;
                    border:none;
                    cursor:pointer;
                    opacity:${isSolved ? '0.7' : '1'};
                    position:relative;
                ">
                #${idx+1}
                ${isSolved ? '<span style="position:absolute;top:6px;right:8px;font-size:1.1em;">✔️</span>' : ''}
            </button>
            `;
        });
        document.getElementById("city-list-popup").style.display = "block";
    }
    function closeCityListPopup() {
        document.getElementById("city-list-popup").style.display = "none";
    }
    window.selectCity = function(idx) {
        loadCity(idx);
        closeCityListPopup();
    };

    // --- Game Logic ---
    function guessCityByCoords(lat, lng) {
        attempts++;
        let dist = calcDistance(lat, lng, correctCoords[0], correctCoords[1]);
        let arrow = getDirectionArrow(lat, lng, correctCoords[0], correctCoords[1]);
        showLoadingBar(() => {
            if (dist < selectedCity.radius) {
                showResult(true, dist, arrow);
            } else if (attempts >= 5) {
                showResult(false, dist, arrow);
            } else {
                showHint(dist, arrow);
                if (currentImage < images.length - 1) {
                    currentImage++;
                    document.getElementById("main-image").src = images[currentImage];
                }
            }
        });
    }
    function showLoadingBar(callback) {
        const loadingBarContainer = document.getElementById("loading-bar-container");
        const loadingBar = document.getElementById("loading-bar");
        loadingBarContainer.style.display = "block";
        loadingBar.style.width = "0%";
        setTimeout(() => { loadingBar.style.width = "100%"; }, 50);
        setTimeout(() => {
            loadingBarContainer.style.display = "none";
            loadingBar.style.width = "0%";
            callback();
        }, 1100);
    }
    function calcDistance(lat1, lon1, lat2, lon2) {
        function toRad(v) { return v * Math.PI / 180; }
        let R = 6371;
        let dLat = toRad(lat2 - lat1);
        let dLon = toRad(lon2 - lon1);
        let a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
        let c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }
    function getDirectionArrow(lat1, lon1, lat2, lon2) {
        let dLat = lat2 - lat1;
        let dLon = lon2 - lon1;
        let angle = Math.atan2(dLon, dLat) * 180 / Math.PI;
        if(angle < 0) angle += 360;
        if(angle >= 337.5 || angle < 22.5) return "⬆️";
        if(angle >= 22.5 && angle < 67.5) return "↗️";
        if(angle >= 67.5 && angle < 112.5) return "➡️";
        if(angle >= 112.5 && angle < 157.5) return "↘️";
        if(angle >= 157.5 && angle < 202.5) return "⬇️";
        if(angle >= 202.5 && angle < 247.5) return "↙️";
        if(angle >= 247.5 && angle < 292.5) return "⬅️";
        return "↖️";
    }
    function getEmojiByDistance(dist) {
        if(dist <= 10) return "✅";
        if(dist >= 11 && dist <= 100) return "🟨";
        if(dist >= 101 && dist <= 199) return "🟧";
        return "🟥";
    }
    function showHint(dist, arrow) {
        let emoji = getEmojiByDistance(dist);
        let feedback = (dist < 10) ? "إجابة صحيحة!" : "إجابة خاطئة!";
        document.getElementById("result").innerHTML = `
            <div class="result-card" style="font-size:1.3em;">
                ${emoji} ${arrow}<br>
                <span>${feedback}</span>
            </div>
        `;
    }
    function showResult(win, dist, arrow) {
    document.getElementById("hint-btn").style.display = "none"; // Hide hint button
    if(win){
        markCitySolved(cityIndex);
        document.getElementById("result").innerHTML = `
            <div class="result-card" style="background:#c8e6c9; color:#256029; font-size:1.5em; border:2px solid #388e3c;">
                ✅ أحسنت! الإجابة صحيحة 🎉<br>${correctCity}
            </div>`;
        document.getElementById("map-thumb").style.display = "none";
        document.getElementById("main-image").style.display = "none";
        showQuiz();
        showWinPopup();
    } else {
        document.getElementById("result").innerHTML = `
            <div class="result-card" style="background:#ffcdd2; color:#b71c1c; font-size:1.5em; border:2px solid #b71c1c;">
                ❌ انتهت المحاولات أو الإجابة خاطئة<br>المدينة الصحيحة: ${correctCity}
            </div>`;
        showQuiz();
        showGallery();
    }
}
    function showQuiz(){
        let quizDiv = document.getElementById("quiz");
        let quizArr = selectedCity.quiz;
        let html = `<div class="quiz"><h3>حاب تختبر نفسك في ${correctCity}؟</h3>`;
        quizArr.forEach((q, idx) => {
            html += `<p>${q.question}</p>`;
            q.options.forEach(opt => {
                html += `<button class="quiz-btn" data-q="${idx}" data-opt="${opt}">${opt}</button>`;
            });
        });
        html += `</div>`;
        quizDiv.innerHTML = html;
        document.querySelectorAll('.quiz-btn').forEach(btn => {
            btn.onclick = function() {
                let qIdx = parseInt(this.getAttribute('data-q'));
                let selected = this.getAttribute('data-opt').trim();
                let correct = quizArr[qIdx].correct.trim();
                if(selected === correct){
                    this.style.background = "#c8e6c9";
                    this.innerText += " ✅";
                } else {
                    this.style.background = "#ffcdd2";
                    this.innerText += " ❌";
                }
                document.querySelectorAll(`.quiz-btn[data-q="${qIdx}"]`).forEach(b => b.disabled = true);
            };
        });
    }
    function showWinPopup() {
        let streak = Number(localStorage.getItem("currentStreak") || 0) + 1;
        let maxStreak = Math.max(streak, Number(localStorage.getItem("maxStreak") || 0));
        localStorage.setItem("currentStreak", streak);
        localStorage.setItem("maxStreak", maxStreak);
        document.getElementById("current-streak").textContent = streak;
        document.getElementById("max-streak").textContent = maxStreak;
        document.getElementById("win-popup").style.display = "block";
        document.getElementById("win-content-default").style.display = "block";
        document.getElementById("win-content-stats").style.display = "none";
        document.getElementById("tab-default").style.fontWeight = "bold";
        document.getElementById("tab-stats").style.fontWeight = "normal";
        document.getElementById("share-btn").onclick = function() {
            let shareText = `SaudiDle\nاليوم: ${correctCity}\nعدد المحاولات: ${attempts}\nسلسلتك الحالية: ${streak}\nأعلى سلسلة: ${maxStreak}\nجرب بنفسك: https://yourwebsite.com`;
            navigator.clipboard.writeText(shareText);
            this.textContent = "تم النسخ!";
            setTimeout(() => { this.textContent = "مشاركة النتيجة"; }, 1500);
        };
        document.getElementById("tab-default").onclick = function() {
            const statsDiv = document.getElementById("win-content-stats");
            const defaultDiv = document.getElementById("win-content-default");
            statsDiv.classList.remove("fade-in");
            statsDiv.classList.add("fade-out");
            setTimeout(() => {
                statsDiv.style.display = "none";
                defaultDiv.style.display = "block";
                defaultDiv.classList.add("fade-in");
                document.getElementById("tab-default").style.fontWeight = "bold";
                document.getElementById("tab-stats").style.fontWeight = "normal";
                setTimeout(() => defaultDiv.classList.remove("fade-in"), 400);
                statsDiv.classList.remove("fade-out");
            }, 300);
        };
        document.getElementById("tab-stats").onclick = function() {
            const statsDiv = document.getElementById("win-content-stats");
            const defaultDiv = document.getElementById("win-content-default");
            defaultDiv.classList.remove("fade-in");
            defaultDiv.classList.add("fade-out");
            setTimeout(() => {
                defaultDiv.style.display = "none";
                statsDiv.style.display = "block";
                statsDiv.classList.add("fade-in");
                document.getElementById("tab-stats").style.fontWeight = "bold";
                document.getElementById("tab-default").style.fontWeight = "normal";
                renderStats();
                setTimeout(() => statsDiv.classList.remove("fade-in"), 400);
                defaultDiv.classList.remove("fade-out");
            }, 300);
        };
    }
    function closeWinPopup() {
        document.getElementById("win-popup").style.display = "none";
        showGallery();
    }

// --- Map Section ---
// Improved: expand on hover, marker/confirm logic, confirm button hides correctly

// --- Map Section ---
// Improved: expand/collapse logic for desktop and mobile, confirm button hides correctly

let map = L.map('map-thumb', { zoomControl: false, attributionControl: false }).setView([23.8859, 45.0792], 5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18 }).addTo(map);
let userMarker = null;

const mapThumb = document.getElementById("map-thumb");
const closeMapBtn = document.getElementById("close-map-btn");
const confirmMapBtn = document.getElementById("confirm-map-btn");

// Device check
function isMobile() {
    return window.innerWidth <= 600;
}

// Expand/collapse logic
if (isMobile()) {
    mapThumb.onclick = function() {
        mapThumb.classList.add("expanded");
        closeMapBtn.style.display = "block";
        setTimeout(() => { map.invalidateSize(); }, 300);
    };
    closeMapBtn.onclick = function(e) {
        mapThumb.classList.remove("expanded");
        closeMapBtn.style.display = "none";
        confirmMapBtn.style.display = "none";
        setTimeout(() => { map.invalidateSize(); }, 300);
        e.stopPropagation();
    };
} else {
    mapThumb.onmouseenter = function() {
        mapThumb.classList.add("expanded");
        closeMapBtn.style.display = "block";
        setTimeout(() => { map.invalidateSize(); }, 300);
    };
    mapThumb.onmouseleave = function() {
        mapThumb.classList.remove("expanded");
        closeMapBtn.style.display = "none";
        confirmMapBtn.style.display = "none";
        setTimeout(() => { map.invalidateSize(); }, 300);
    };
    closeMapBtn.onclick = function(e) {
        mapThumb.classList.remove("expanded");
        closeMapBtn.style.display = "none";
        confirmMapBtn.style.display = "none";
        setTimeout(() => { map.invalidateSize(); }, 300);
        e.stopPropagation();
    };
}

// Place marker and show confirm button
map.on('click', function(e) {
    if (userMarker) map.removeLayer(userMarker);
    userMarker = L.marker([e.latlng.lat, e.latlng.lng]).addTo(map);
    confirmMapBtn.style.display = "block";
});

// Confirm guess and hide confirm button
confirmMapBtn.onclick = function() {
    if (userMarker) {
        const latlng = userMarker.getLatLng();
        guessCityByCoords(latlng.lat, latlng.lng);
        confirmMapBtn.style.display = "none";
    }
};

// Hide confirm button when loading a new city
function loadCity(idx) {
    // ...existing code...
    if (userMarker) {
        map.removeLayer(userMarker);
        userMarker = null;
    }
    confirmMapBtn.style.display = "none";
    // ...existing code...
}



    function showGallery() {
        document.getElementById("image-container").style.display = "none";
        const galleryDiv = document.getElementById("gallery");
        let html = '<h2 style="color:#1B9E49;">كل الصور لهذا اليوم</h2><div style="display:flex;flex-wrap:wrap;justify-content:center;gap:24px;">';
        const imageDescriptions = selectedCity.imageDescriptions;
        images.forEach((imgSrc, idx) => {
            html += `
            <div style="background:#1F2023;padding:16px;border-radius:32px;width:320px;box-sizing:border-box;">
                <img src="${imgSrc}" style="width:100%;height:200px;object-fit:cover;border-radius:18px;box-shadow:0 0 12px #222;">
                <div style="margin-top:8px;color:#D9D9D9;font-size:0.95em;">
                    ${imageDescriptions[idx] || `صورة رقم ${idx+1}`}
                </div>
            </div>`;
        });
        html += '</div>';
        galleryDiv.innerHTML = html;
        galleryDiv.style.display = "block";
    }
    function renderStats() {
        const attemptEmojis = ["1️⃣", "2️⃣", "3️⃣", "4️⃣", "5️⃣"];
        let triesStats = JSON.parse(localStorage.getItem("triesStats") || "[0,0,0,0,0]");
        triesStats[attempts-1] = (triesStats[attempts-1] || 0) + 1;
        localStorage.setItem("triesStats", JSON.stringify(triesStats));
        let total = triesStats.reduce((a,b)=>a+b,0) || 1;
        let barHtml = `<div style="text-align:right; margin-bottom:10px;">عدد محاولاتك في الايام السابقة:</div>`;
        for(let i=0; i<5; i++) {
            let percent = Math.round(triesStats[i]/total*100);
            barHtml += `
            <div style="display:flex; align-items:center; margin-bottom:6px;">
                <span style="width:40px; font-size:1.5em;">${attemptEmojis[i]}</span>
                <div style="flex:1; background:#90caf9; height:22px; border-radius:4px; margin:0 8px; position:relative;">
                    <div style="width:${percent}%; background:#1976d2; height:100%; border-radius:4px;"></div>
                </div>
                <span style="width:40px; font-size:0.95em;">${triesStats[i]} (${percent}%)</span>
            </div>`;
        }
        document.getElementById("horizontal-bar").innerHTML = barHtml;
        let vBarHtml = `<div style="display:flex; align-items:flex-end; justify-content:center; height:100px;">`;
        for(let i=0; i<5; i++) {
            let percent = Math.round(triesStats[i]/total*100);
            vBarHtml += `
            <div style="margin:0 6px; text-align:center;">
                <div style="background:#a5d6a7; width:32px; height:${percent}px; border-radius:6px 6px 0 0; position:relative;">
                    <span style="position:absolute;top:-24px;left:50%;transform:translateX(-50%);font-size:0.95em;">${percent}%</span>
                </div>
                <span style="font-size:1.5em;">${attemptEmojis[i]}</span>
            </div>`;
        }
        vBarHtml += `</div>`;
        document.getElementById("vertical-bar").innerHTML = vBarHtml;
    }
    function loadCity(idx) {
    cityIndex = idx;
    selectedCity = cityData[cityIndex];
    images = selectedCity.images;
    currentImage = 0;
    correctCity = selectedCity.name;
    correctCoords = selectedCity.coords;
    attempts = 0;
    document.getElementById("main-image").src = images[0];
    updateCityNumber();
    document.getElementById("result").innerHTML = "";
    document.getElementById("quiz").innerHTML = "";
    document.getElementById("hint-message").innerHTML = "";
    document.getElementById("image-container").style.display = "block";
    document.getElementById("main-image").style.display = "block";
    document.getElementById("gallery").style.display = "none";
    document.getElementById("map-thumb").style.display = "block";
    if (userMarker) {
        map.removeLayer(userMarker);
        userMarker = null;
    }
    confirmMapBtn.style.display = "none";
}
    document.getElementById("stats-top-btn").onclick = showWinPopup;
    document.getElementById("help-top-btn").onclick = showPopup;
    </script>
</body>
</html>